<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Green - 设备调试</title>
    <link rel="stylesheet" href="../css/device-setup.css">
</head>
<body class="device-setup-page">
    <div class="device-setup-container">
        <div class="bg-layer">
            <!-- 添加背景点缀元素 -->
            <div class="bg-dots"></div>
            <div class="bg-circle-1"></div>
            <div class="bg-circle-2"></div>
            <div class="bg-circle-3"></div>
        </div>
        
        <header class="header">
            <div class="logo"><img src="ui/asset/logo.png" alt="Green Logo" style="height: 24px;"></div>
            <div class="header-title">设备调试</div>
        </header>
        
        <!-- 公共说明部分，所有设备页面共用 -->
        <div class="device-common-area">
            <div class="device-guide-container">
                <h2 class="section-title">设备连接指南</h2>
                <ul class="device-guide">
                    <li>确保所有设备的电源已开启</li>
                    <li>将传感器正确放置在身体相应位置</li>
                    <li>人物位于摄像头正前方</li>
                    <li>连接成功后，会显示实时数据</li>
                </ul>
            </div>
            
            <!-- 步骤指示器 -->
            <div class="step-indicator">
                <div class="step-dot" data-step="0"></div>
                <div class="step-dot" data-step="1"></div>
                <div class="step-dot" data-step="2"></div>
                <div class="step-dot" data-step="3"></div>
            </div>
        </div>
        
        <!-- 设备页面容器 -->
        <div id="device-pages-container">
            <!-- 皮电传感器页面 -->
            <div id="device-page-0" class="device-page active-device-page">
                <div class="device-container">
                    <div class="device-info">
                        <div class="device-icon skin-icon"></div>
                        <h3 class="device-name">皮电传感器</h3>
                        <p class="device-desc">请将传感器套在在非惯用手的食指和中指根</p>
                    </div>
                    
                    <div style="text-align: center; margin: 10px 0;">
                        <img src="ui/asset/皮电指示.png" alt="皮电传感器使用指南" style="max-width: 35%; height: auto; border-radius: 8px;">
                    </div>
                    
                    <div class="connection-area">
                        <div class="connection-status"></div>
                        <div class="waiting-text">等待设备连接...</div>
                        <div class="skin-data-container" style="display: none;">
                            <div class="skin-data-label">皮电值：<span class="skin-data-display">--</span> μS</div>
                            <svg class="skin-data-svg" width="90%" height="120px" style="display: block; margin: 0 auto;"></svg>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="action-btn connect-btn" data-device="0">连接设备</button>
                    </div>
                </div>
            </div>
            
            <!-- 心率传感器页面 -->
            <div id="device-page-1" class="device-page">
                <div class="device-container">
                    <div class="device-info">
                        <div class="device-icon heart-icon"></div>
                        <h3 class="device-name">心率传感器</h3>
                        <p class="device-desc">请将传感器套在非惯用手食指指尖，确保稳固</p>
                    </div>
                    
                    <div style="text-align: center; margin: 10px 0;">
                        <img src="ui/asset/心率指示.png" alt="心率传感器使用指南" style="max-width: 35%; height: auto; border-radius: 8px;">
                    </div>
                    
                    <div class="connection-area">
                        <div class="connection-status"></div>
                        <div class="waiting-text">等待设备连接...</div>
                        <div class="heart-rate-container" style="display: none;">
                            <div class="heart-rate-label">心率：<span class="heart-rate-display">--</span> BPM</div>
                            <svg class="heart-rate-svg" width="90%" height="120px" style="display: block; margin: 0 auto;"></svg>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="action-btn connect-btn" data-device="1">连接设备</button>
                    </div>
                </div>
            </div>
            
            <!-- 摄像头页面 -->
            <div id="device-page-2" class="device-page">
                <div class="device-container">
                    <div class="device-info">
                        <div class="device-icon camera-icon"></div>
                        <h3 class="device-name">摄像头</h3>
                        <p class="device-desc">请确保光线充足，面部完全进入画面</p>
                    </div>
                    
                    <div class="connection-area">
                        <div class="connection-status"></div>
                        <div class="waiting-text">等待摄像头启动...</div>
                        <div class="camera-container" style="display: none;">
                            <video id="camera-preview" width="100%" height="360px" autoplay muted></video>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="action-btn connect-btn" data-device="2">启动摄像头</button>
                    </div>
                </div>
            </div>
            
            <!-- 数位板页面 -->
            <div id="device-page-3" class="device-page">
                <div class="device-container">
                    <div class="device-info">
                        <div class="device-icon tablet-icon"></div>
                        <h3 class="device-name">数位板</h3>
                        <p class="device-desc">请在下方区域进行测试绘制，确认压感正常</p>
                    </div>
                    
                    <div class="connection-area">
                        <div class="connection-status"></div>
                        <div class="waiting-text">等待设备连接...</div>
                        <div class="tablet-container" style="display: none;">
                            <canvas id="tablet-canvas" width="100%" height="120px" style="height: 120px !important; max-height: 120px !important;"></canvas>
                            <div class="tablet-controls">
                                <button class="tablet-btn clear-btn">清除画布</button>
                                <div class="pressure-display">压感：<span class="pressure-value">--</span></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="action-btn connect-btn" data-device="3">连接数位板</button>
                    </div>
                </div>
            </div>
        </div>
        
        <footer class="footer">
            <button id="prev-step" class="footer-btn prev-btn">上一步</button>
            <button id="skip-setup" class="footer-btn skip-btn">跳过设置</button>
            <button id="next-step" class="footer-btn next-btn">下一步</button>
        </footer>
        
        <!-- 确认跳过的模态框 -->
        <div class="modal">
            <div class="modal-content">
                <h3 class="modal-title">确认跳过</h3>
                <p class="modal-text">确定要跳过设备设置吗？这可能会影响您的使用体验。</p>
                <div class="modal-buttons">
                    <button class="btn-cancel">取消</button>
                    <button class="btn-confirm">确认</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 导入脚本 -->
    <script src="../js/device-setup.js"></script>
    
    <!-- 确保页面与导航系统正确集成 -->
    <script>
        // 检测是否在iframe或作为子页面加载
        function isEmbedded() {
            try {
                return window !== window.parent || 
                       window.frameElement !== null || 
                       window.parent.navigateToPage !== undefined;
            } catch (e) {
                // 如果跨域访问父窗口出错，则认为是在iframe中
                return true;
            }
        }
        
        // 触发初始化
        function triggerPageInit() {
            // 如果是作为子页面加载的，且未初始化
            if (isEmbedded() && !window.deviceSetupInitialized) {
                console.log('页面直接触发初始化');
                // 创建自定义事件
                const initEvent = new CustomEvent('pageLoaded', {
                    detail: {
                        pageId: 'device-setup-page',
                        timestamp: new Date()
                    }
                });
                // 触发事件
                window.dispatchEvent(initEvent);
                
                // 备用方法：直接调用初始化函数
                if (typeof initDeviceSetup === 'function' && !window.deviceSetupInitialized) {
                    setTimeout(initDeviceSetup, 100);
                }
            }
        }
        
        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            // 连接导航系统
            if (window.parent && window.parent.navigateToPage) {
                console.log('连接到父窗口导航系统');
                window.navigateToPage = window.parent.navigateToPage;
            }
            
            // 修复顶部导航链接
            const logo = document.querySelector('.logo');
            if (logo) {
                logo.addEventListener('click', function() {
                    if (window.navigateToPage) {
                        window.navigateToPage('welcome-page');
                    } else {
                        window.location.href = 'welcome.html';
                    }
                });
            }
            
            // 触发页面初始化
            setTimeout(triggerPageInit, 300);
        });
        
        // 备用：页面可见性变化时也检查初始化
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && !window.deviceSetupInitialized) {
                triggerPageInit();
            }
        });
    </script>
</body>
</html> 