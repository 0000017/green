<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Green</title>
    <link rel="stylesheet" href="style.css">
    <!-- 3D情感模型样式 -->
    <link rel="stylesheet" href="./three/emotion-model.css">
    
    <!-- HTML5 Canvas polyfill，解决兼容性问题 -->
    <script>
    // 修复某些浏览器中的canvas兼容性问题
    if (!HTMLCanvasElement.prototype.toBlob) {
        Object.defineProperty(HTMLCanvasElement.prototype, 'toBlob', {
            value: function(callback, type, quality) {
                const dataURL = this.toDataURL(type, quality);
                const binStr = atob(dataURL.split(',')[1]);
                const len = binStr.length;
                const arr = new Uint8Array(len);
                for (let i = 0; i < len; i++) {
                    arr[i] = binStr.charCodeAt(i);
                }
                callback(new Blob([arr], {type: type || 'image/png'}));
            }
        });
    }
    </script>
    
    <!-- 加载face-api.js -->
    <script src="./opencv/emotion_model/face-api.js/dist/face-api.min.js"></script>
</head>
<body>
    <!-- 视频流 -->
    <video id="videoStream" autoplay playsinline></video>
    
    <!--webrtc状态显示切换按钮 -->
    <div id="status-toggle" class="status-toggle">i</div>
    
    <!-- 表情识别悬浮窗口 -->
    <div id="emotion-floating-window" class="emotion-floating-window">
        <div class="floating-header">
            <h3>情感数据</h3>
            <div class="status-indicator">
                <span class="status-dot" id="recognition-status-dot" role="button"></span>
            </div>
        </div>
        <div class="floating-content">
            <div class="video-container">
                <video id="floating-video" autoplay playsinline></video>
                <canvas id="outputCanvas" class="overlay-canvas"></canvas>
                <div class="emotion-panel" id="emotion-panel">
                    <div class="panel-header">
                        <h3>当前情绪</h3>
                    </div>
                    <div class="emotion-status">
                        <span id="current-emotion">未检测</span>
                    </div>
                    <div class="emotion-bar-container">
                        <div id="emotion-bar" class="emotion-bar"></div>
                    </div>
                    <!-- 生物传感器数据区域将由JS动态添加 -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- 3D情感模型容器 -->
    <div id="emotion-model-container"></div>
    
    <!-- 调试信息区域 -->
    <div id="debug-info"></div>
    
    <!-- 功能模块脚本 -->
    <script src="./opencv/emotion-recognition.js"></script>
    <script src="./opencv/emotion-ui.js"></script>
    <script src="./webrtc_config/ui.js"></script>
    <script src="./webrtc_config/renderer.js"></script>
    
    <!-- 生物传感器模块 -->
    <script>
        // 加载Arduino生物传感器模块和情感3D模型
        window.addEventListener('DOMContentLoaded', () => {
            try {
                // 加载生物传感器模块
                const biometricData = require('./arhuino/biometric-data');
                const biometricUI = require('./arhuino/biometric-ui');
                const emotionFusion = require('./arhuino/emotion-fusion');
                
                // 加载3D情感模型
                const emotionModel = require('./three/emotion-model');
                
                // 初始化生物传感器UI
                setTimeout(() => {
                    // 初始化生物传感器UI
                    biometricUI.init('#emotion-panel').catch(err => {
                        console.error('初始化生物传感器UI失败:', err);
                    });
                    
                    // 初始化情感融合模块
                    emotionFusion.init();
                    
                    // 初始化3D情感模型
                    emotionModel.init('#emotion-model-container');
                    
                    // 添加情感融合数据监听
                    emotionFusion.addUpdateListener((fusedData) => {
                        // 可以在这里处理融合后的情感数据，但已经通过事件通知3D模型了
                        console.log('融合情感数据更新:', fusedData);
                    });
                    
                    console.log('所有情感相关模块初始化完成');
                }, 1000); // 延迟初始化，确保emotion-panel已加载
                
                console.log('模块加载成功');
            } catch (err) {
                console.error('加载模块失败:', err);
            }
        });
    </script>
</body>
</html>
