<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Green</title>
    <link rel="stylesheet" href="style.css">
    <!-- 3D情感模型样式 -->
    <link rel="stylesheet" href="./three/emotion-model.css">
    
    <!-- HTML5 Canvas polyfill，解决兼容性问题 -->
    <script>
    // 修复某些浏览器中的canvas兼容性问题
    if (!HTMLCanvasElement.prototype.toBlob) {
        Object.defineProperty(HTMLCanvasElement.prototype, 'toBlob', {
            value: function(callback, type, quality) {
                const dataURL = this.toDataURL(type, quality);
                const binStr = atob(dataURL.split(',')[1]);
                const len = binStr.length;
                const arr = new Uint8Array(len);
                for (let i = 0; i < len; i++) {
                    arr[i] = binStr.charCodeAt(i);
                }
                callback(new Blob([arr], {type: type || 'image/png'}));
            }
        });
    }
    
    // 定义一个全局错误处理函数，处理平台设置冲突
    window.handlePlatformConflict = function(e) {
        if (e && e.message && e.message.includes('Platform browser has already been set')) {
            console.warn('忽略平台设置冲突:', e.message);
            return true; // 已处理
        }
        return false; // 未处理
    };
    
    // 捕获全局错误
    window.addEventListener('error', function(e) {
        if (window.handlePlatformConflict(e.error)) {
            e.preventDefault();
        }
    });
    </script>
</head>
<body>
    <!-- 视频流 -->
    <video id="videoStream" autoplay playsinline></video>
    
    <!--webrtc状态显示切换按钮 -->
    <div id="status-toggle" class="status-toggle">i</div>
    
    <!-- 表情识别悬浮窗口 -->
    <div id="emotion-floating-window" class="emotion-floating-window">
        <div class="floating-header">
            <h3>情感数据</h3>
            <div class="status-indicator">
                <span class="status-dot" id="recognition-status-dot" role="button"></span>
            </div>
        </div>
        <div class="floating-content">
            <div class="video-container">
                <video id="floating-video" autoplay playsinline></video>
                <canvas id="outputCanvas" class="overlay-canvas"></canvas>
                <div class="emotion-panel" id="emotion-panel">
                    <div class="panel-header">
                        <h3>当前情绪</h3>
                    </div>
                    <div class="emotion-status">
                        <span id="current-emotion">未检测</span>
                    </div>
                    <div class="emotion-bar-container">
                        <div id="emotion-bar" class="emotion-bar"></div>
                    </div>
                    <!-- 生物传感器数据区域将由JS动态添加 -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- 3D情感模型容器 -->
    <div id="emotion-model-container"></div>
    
    <!-- 调试信息区域 -->
    <div id="debug-info"></div>
    
    <!-- 功能模块脚本 -->
    <!-- 先加载主要WebRTC脚本，确保videoElement变量先被声明 -->
    <script src="./webrtc_config/ui.js"></script>
    <script src="./webrtc_config/renderer.js"></script>
    
    <!-- 加载face-api.js -->
    <script>
        try {
            // 使用异步加载方式
            const script = document.createElement('script');
            script.src = "./opencv/emotion_model/face-api.js/dist/face-api.min.js";
            script.onerror = function(e) {
                console.error('加载face-api.js失败:', e);
            };
            document.body.appendChild(script);
        } catch (e) {
            console.error('创建face-api.js脚本标签失败:', e);
        }
    </script>
    
    <!-- 最后加载情感识别脚本，避免变量冲突 -->
    <script src="./opencv/emotion-recognition.js"></script>
    <script src="./opencv/emotion-ui.js"></script>
    
    <!-- 生物传感器模块 -->
    <script>
        // 全局定义THREE变量，确保模块能访问
        // 直接从node_modules中引入Three.js
        window.THREE = require('three');
        console.log('THREE.js版本:', THREE.REVISION);
        
        // 加载Arduino生物传感器模块和情感3D模型
        window.addEventListener('DOMContentLoaded', () => {
            try {
                // 加载生物传感器模块
                const biometricData = require('./arhuino/biometric-data');
                const biometricUI = require('./arhuino/biometric-ui');
                const emotionFusion = require('./arhuino/emotion-fusion');
                
                // 加载3D情感模型
                const emotionModel = require('./three/emotion-model');
                
                // 初始化生物传感器UI
                setTimeout(() => {
                    // 检查THREE对象是否可用
                    if (typeof window.THREE === 'undefined') {
                        console.error('THREE.js未正确加载');
                        window.THREE = require('three');
                    }
                    
                    // 初始化生物传感器UI
                    biometricUI.init('#emotion-panel').catch(err => {
                        console.error('初始化生物传感器UI失败:', err);
                    });
                    
                    // 初始化情感融合模块
                    emotionFusion.init();
                    
                    // 初始化3D情感模型
                    const modelInitResult = emotionModel.init('#emotion-model-container');
                    console.log('情感模型初始化结果:', modelInitResult);
                    
                    // 添加情感融合数据监听
                    emotionFusion.addUpdateListener((fusedData) => {
                        // 测试直接调用模型更新，避免事件监听可能存在的问题
                        if (emotionModel.handleEmotionUpdate) {
                            console.log('直接调用模型更新:', fusedData);
                            // 创建一个包含detail的对象，模拟自定义事件格式
                            emotionModel.handleEmotionUpdate({
                                detail: {
                                    valence: fusedData.X,  // 效价 - 新Y轴
                                    arousal: fusedData.Y,  // 唤醒度 - 新Z轴
                                    dominant_emotion: fusedData.Z,  // 情感类型 - 新X轴
                                    confidence: fusedData.confidence
                                }
                            });
                        }
                        console.log('融合情感数据更新:', fusedData);
                    });
                    
                    // 发送测试数据
                    setTimeout(() => {
                        console.log('发送测试情感数据');
                        // 创建测试事件
                        const testEvent = new CustomEvent('emotionFusionUpdate', {
                            detail: {
                                valence: 50,  // 效价 - Y轴
                                arousal: 70,  // 唤醒度 - Z轴
                                dominant_emotion: '开心', // 情感类型 - X轴
                                confidence: 0.9
                            }
                        });
                        document.dispatchEvent(testEvent);
                    }, 2000);
                    
                    console.log('所有情感相关模块初始化完成');
                }, 1000); // 延迟初始化，确保emotion-panel已加载
                
                console.log('模块加载成功');
            } catch (err) {
                console.error('加载模块失败:', err);
                console.error(err.stack || err);
            }
        });
    </script>
</body>
</html>
