<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Green</title>
    <link rel="stylesheet" href="style.css">
    <!-- 3D情感模型样式 -->
    <link rel="stylesheet" href="./three/emotion-model.css">
    <!-- P5绘画工具样式 -->
    <link rel="stylesheet" href="./P5/styles.css">
    
    <style>
        /* 情感分析系统容器样式 */
        .emotion-analysis-container {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 480px;
            z-index: 9000;
        }
        
        /* 调整悬浮窗口样式，使其自适应容器 */
        .emotion-floating-window {
            position: relative;
            top: auto;
            right: auto;
            width: 100%;
            margin: 0;
        }
        
        /* 调整3D模型容器样式，使其自适应容器 */
        #emotion-model-container {
            position: relative;
            width: 100%;
            max-width: 100%;
            height: 300px;
            top: auto;
            right: auto;
            margin: 0;
        }
        
        /* 绘画工具控制按钮 */
        #p5-toggle-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 10px 15px;
            cursor: pointer;
            z-index: 9500;
        }
        
        #p5-toggle-btn:hover {
            background-color: #45a049;
        }
    </style>
    
    <!-- HTML5 Canvas polyfill，解决兼容性问题 -->
    <script>
    // 修复某些浏览器中的canvas兼容性问题
    if (!HTMLCanvasElement.prototype.toBlob) {
        Object.defineProperty(HTMLCanvasElement.prototype, 'toBlob', {
            value: function(callback, type, quality) {
                const dataURL = this.toDataURL(type, quality);
                const binStr = atob(dataURL.split(',')[1]);
                const len = binStr.length;
                const arr = new Uint8Array(len);
                for (let i = 0; i < len; i++) {
                    arr[i] = binStr.charCodeAt(i);
                }
                callback(new Blob([arr], {type: type || 'image/png'}));
            }
        });
    }
    
    // 定义一个全局错误处理函数，处理平台设置冲突
    window.handlePlatformConflict = function(e) {
        if (e && e.message && e.message.includes('Platform browser has already been set')) {
            console.warn('忽略平台设置冲突:', e.message);
            return true; // 已处理
        }
        return false; // 未处理
    };
    
    // 捕获全局错误
    window.addEventListener('error', function(e) {
        if (window.handlePlatformConflict(e.error)) {
            e.preventDefault();
        }
    });
    </script>
</head>
<body>
    <!-- 视频流 -->
    <video id="videoStream" autoplay playsinline></video>
    
    <!--webrtc状态显示切换按钮 -->
    <div id="status-toggle" class="status-toggle">i</div>
    
    <!-- 情感分析系统容器 -->
    <div id="emotion-analysis-container" class="emotion-analysis-container">
        <!-- 表情识别窗口 -->
        <div id="emotion-floating-window" class="emotion-floating-window">
            <div class="floating-header">
                <div class="status-indicator">
                    <span class="status-dot" id="recognition-status-dot" role="button"></span>
                </div>
            </div>
            <div class="floating-content">
                <div class="video-container">
                    <video id="floating-video" autoplay playsinline></video>
                    <canvas id="outputCanvas" class="overlay-canvas"></canvas>
                    <div class="emotion-panel" id="emotion-panel">
                        <div class="panel-header">
                            <h3>面部情绪分析</h3>
                            <div class="status-indicator">
                                <span class="status-dot" id="panel-status-dot" role="button"></span>
                            </div>
                        </div>
                        <div class="emotion-status">
                            <span id="current-emotion" class="emotion-未检测">未检测</span>
                        </div>
                        <div class="emotion-bar-container">
                            <div id="emotion-bar" class="emotion-bar"></div>
                        </div>
                        <!-- 生物传感器数据区域将由JS动态添加 -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 3D情感模型容器 -->
        <div id="emotion-model-container"></div>
    </div>
    
    <!-- 调试信息区域 -->
    <div id="debug-info"></div>
    
    <!-- P5绘画工具切换按钮 -->
    <button id="p5-toggle-btn">绘画工具</button>
    
    <!-- 功能模块脚本 -->
    <!-- 先加载主要WebRTC脚本，确保videoElement变量先被声明 -->
    <script src="./webrtc_config/ui.js"></script>
    <script src="./webrtc_config/renderer.js"></script>
    
    <!-- 加载face-api.js -->
    <script>
        try {
            // 使用异步加载方式
            const script = document.createElement('script');
            script.src = "./opencv/emotion_model/face-api.js/dist/face-api.min.js";
            script.onerror = function(e) {
                console.error('加载face-api.js失败:', e);
            };
            document.body.appendChild(script);
        } catch (e) {
            console.error('创建face-api.js脚本标签失败:', e);
        }
    </script>
    
    <!-- 最后加载情感识别脚本，避免变量冲突 -->
    <script src="./opencv/emotion-recognition.js"></script>
    <script src="./opencv/emotion-ui.js"></script>
    
    <!-- 生物传感器模块 -->
    <script>
        // 全局定义THREE变量，确保模块能访问
        // 直接从node_modules中引入Three.js
        window.THREE = require('three');
        console.log('THREE.js版本:', THREE.REVISION);
        
        // 加载生物传感器模块
        window.addEventListener('DOMContentLoaded', () => {
            try {
                // 加载生物传感器模块
                const biometricData = require('./arhuino/biometric-data');
                const biometricUI = require('./arhuino/biometric-ui');
                const emotionFusion = require('./arhuino/emotion-fusion');
                
                // 加载3D情感模型
                const emotionModel = require('./three/emotion-model');
                
                console.log('开始初始化情感分析系统...');
                
                // 初始化生物传感器UI和3D模型 - 增加延迟以确保DOM完全加载
                setTimeout(() => {
                    // 检查THREE对象是否可用
                    if (typeof window.THREE === 'undefined') {
                        console.error('THREE.js未正确加载');
                        window.THREE = require('three');
                    }
                    
                    console.log('检查DOM元素: #emotion-panel =', document.querySelector('#emotion-panel'));
                    console.log('检查DOM元素: #emotion-model-container =', document.querySelector('#emotion-model-container'));
                    
                    // 先初始化情感融合模块
                    emotionFusion.init();
                        
                    // 初始化生物传感器UI
                    biometricUI.init('#emotion-panel').catch(err => {
                        console.error('初始化生物传感器UI失败:', err);
                        // 如果初始化失败，尝试直接添加到body
                        console.log('尝试将生物传感器UI添加到容器...');
                        biometricUI.init('#emotion-analysis-container').catch(err2 => {
                            console.error('添加到容器也失败:', err2);
                        });
                    });
                    
                    // 初始化3D情感模型
                    const modelInitResult = emotionModel.init('#emotion-model-container');
                    console.log('情感模型初始化结果:', modelInitResult);
                    
                    // 添加情感融合数据监听
                    emotionFusion.addUpdateListener((fusedData) => {
                        // 测试直接调用模型更新，避免事件监听可能存在的问题
                        if (emotionModel.handleEmotionUpdate) {
                            console.log('情感数据更新:', fusedData);
                            // 创建一个包含detail的对象，模拟自定义事件格式
                            emotionModel.handleEmotionUpdate({
                                detail: {
                                    valence: fusedData.X,  // 效价 - 新Y轴
                                    arousal: fusedData.Y,  // 唤醒度 - 新Z轴
                                    dominant_emotion: fusedData.Z,  // 情感类型 - 新X轴
                                    confidence: fusedData.confidence
                                }
                            });
                        }
                    });
                    
                    // 发送测试数据
                    setTimeout(() => {
                        console.log('发送测试情感数据');
                        // 创建测试事件
                        const testEvent = new CustomEvent('emotionFusionUpdate', {
                            detail: {
                                valence: 50,  // 效价 - Y轴
                                arousal: 70,  // 唤醒度 - Z轴
                                dominant_emotion: '开心', // 情感类型 - X轴
                                confidence: 0.9
                            }
                        });
                        document.dispatchEvent(testEvent);
                    }, 2000);
                    
                    console.log('所有情感相关模块初始化完成');
                    
                    // 将情感融合模块暴露到全局，方便P5模块调用
                    window.emotionFusion = emotionFusion;
                    
                }, 2500); // 增加延迟时间，确保DOM完全加载
                
                console.log('模块加载成功');
            } catch (err) {
                console.error('加载模块失败:', err);
                console.error(err.stack || err);
            }
        });
    </script>
    
    <!-- 加载P5.js库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"></script>
    
    <!-- 加载P5绘画功能模块 -->
    <script src="./P5/draw.js"></script>
    <script src="./P5/brush.js"></script>
    <script src="./P5/camera.js"></script>
    <script src="./P5/emotion.js"></script>
    <script src="./P5/td.js"></script>
    <script src="./P5/sketch.js"></script>
    
    <!-- 初始化P5绘画工具 -->
    <script>
        // 等待DOM加载完成
        document.addEventListener('DOMContentLoaded', function() {
            // 绘画工具状态
            let isP5Active = false;
            
            // 获取切换按钮
            const toggleBtn = document.getElementById('p5-toggle-btn');
            
            // 添加切换按钮点击事件
            toggleBtn.addEventListener('click', function() {
                if (!isP5Active) {
                    // 激活P5绘画工具
                    window.p5Drawing.init();
                    toggleBtn.textContent = '关闭绘画';
                    isP5Active = true;
                } else {
                    // 隐藏P5绘画工具UI
                    const controlPanel = document.getElementById('p5-control-panel');
                    const canvasContainer = document.getElementById('p5-canvas-container');
                    
                    if (controlPanel) {
                        // 移除控制面板
                        document.body.removeChild(controlPanel);
                    }
                    
                    if (canvasContainer) {
                        // 移除画布容器
                        document.body.removeChild(canvasContainer);
                    }
                    
                    toggleBtn.textContent = '绘画工具';
                    isP5Active = false;
                    
                    // 重置p5初始化状态，以便下次可以重新初始化
                    window.isInitialized = false;
                }
            });
        });
    </script>
</body>
</html>
